# Set up the parameters
$SITE_NAME = $args[0]
$PHP_VERSION = $args[1]

$SSL_CERTS_DIRECTORY = '/home/ubuntu/wp-local-env/ssl-certs'
$SITES_DIRECTORY = '/home/ubuntu/wp-local-env/sites'

$MYSQL_DATABASE = $SITE_NAME -replace '[^a-zA-Z0-9]',''
$SITE_CONFIG_PATH = '/etc/apache2/sites-available/{0}.conf' -f $SITE_NAME
$SSL_SITE_CONFIG_PATH = '/etc/apache2/sites-available/{0}-ssl.conf' -f $SITE_NAME

# Set up the virtual hosts
Write-Output 'Setting up virtual hosts...'

$VIRTUAL_HOST = @"
<VirtualHost *:80>
    ServerName $SITE_NAME.test
    Redirect / https://$SITE_NAME.test
</VirtualHost>
"@

Add-Content -Path $SITE_CONFIG_PATH -Value $VIRTUAL_HOST

$SSL_VIRTUAL_HOST = @"
<IfModule mod_ssl.c>
    <VirtualHost _default_:443>
        ServerName $SITE_NAME.test
        ServerAdmin webmaster@$SITE_NAME.test
        DocumentRoot $SITES_DIRECTORY/$SITE_NAME
        <Directory "$SITES_DIRECTORY/$SITE_NAME">
            #Require local
            Order allow,deny
            Allow from all
            AllowOverride all
            # New directive needed in Apache 2.4.3:
            Require all granted
        </Directory>
        ErrorLog ${APACHE_LOG_DIR}/$SITE_NAME-error.log
        CustomLog ${APACHE_LOG_DIR}/$SITE_NAME-access.log combined
        SSLEngine on
        SSLCertificateFile  $SSL_CERTS_DIRECTORY/$SITE_NAME.test.pem
        SSLCertificateKeyFile $SSL_CERTS_DIRECTORY/$SITE_NAME.test-key.pem
        <FilesMatch "\.(cgi|shtml|phtml|php)$">
                SSLOptions +StdEnvVars
        </FilesMatch>
        <Directory /usr/lib/cgi-bin>
                SSLOptions +StdEnvVars
        </Directory>
    </VirtualHost>
</IfModule>
"@

if ($PHP_VERSION -eq '7.4') {
    $SSL_VIRTUAL_HOST = @"
<IfModule mod_ssl.c>
    <VirtualHost _default_:443>
        ServerName $SITE_NAME.test
        ServerAdmin webmaster@$SITE_NAME.test
        DocumentRoot $SITES_DIRECTORY/$SITE_NAME
        <Directory "$SITES_DIRECTORY/$SITE_NAME">
            #Require local
            Order allow,deny
            Allow from all
            AllowOverride all
            # New directive needed in Apache 2.4.3:
            Require all granted
        </Directory>
        ErrorLog ${APACHE_LOG_DIR}/$SITE_NAME-error.log
        CustomLog ${APACHE_LOG_DIR}/$SITE_NAME-access.log combined
        SSLEngine on
        SSLCertificateFile  $SSL_CERTS_DIRECTORY/$SITE_NAME.test.pem
        SSLCertificateKeyFile $SSL_CERTS_DIRECTORY/$SITE_NAME.test-key.pem
        <FilesMatch \.php$>
            # From the Apache version 2.4.10 and above, use the SetHandler to run PHP as a fastCGI process s>
            SetHandler "proxy:unix:/run/php/php7.4-fpm.sock|fcgi://localhost"
        </FilesMatch>
        <FilesMatch "\.(cgi|shtml|phtml|php)$">
                SSLOptions +StdEnvVars
        </FilesMatch>
        <Directory /usr/lib/cgi-bin>
                SSLOptions +StdEnvVars
        </Directory>
    </VirtualHost>
</IfModule>
"@
}

Add-Content -Path $SSL_SITE_CONFIG_PATH -Value $SSL_VIRTUAL_HOST

Write-Output 'Enabling virtual hosts...'

& a2ensite "$SITE_NAME".conf
& a2ensite "$SITE_NAME"-ssl.conf

Write-Output 'Creating database..'

& mysql -uroot -ppassword --execute="CREATE DATABASE $MYSQL_DATABASE;"

Write-Output 'Restarting Apache...'

& service apache2 restart